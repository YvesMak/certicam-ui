<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal Anti-Close</title>
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        body { padding: 40px; }
        .logs {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîß Test Modal Anti-Close</h1>
    
    <button class="btn-primary" id="test-modal-btn">
        <i class="fi fi-rr-plus"></i>
        <span>Ouvrir Modal Test</span>
    </button>
    
    <div class="logs" id="logs">
        Logs d'√©v√©nements...\n
    </div>

    <!-- Modal Test -->
    <div class="modal-overlay" id="testModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>Modal Anti-Close</h3>
                    <p class="modal-subtitle">Ce modal ne devrait pas se fermer automatiquement</p>
                </div>
                <button class="modal-close" id="close-test-modal">
                    <i class="fi fi-rr-cross"></i>
                </button>
            </div>
            
            <div class="modal-content">
                <p>Si vous voyez ce modal et qu'il reste ouvert, la correction fonctionne !</p>
                <p>Cliquez sur la zone grise autour pour tester la fermeture par overlay.</p>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-test">Annuler</button>
                <button class="btn-primary" id="save-test">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${time}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        function openTestModal() {
            log('üöÄ Ouverture du modal test...');
            const modal = document.getElementById('testModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.offsetHeight; // Force reflow
                
                setTimeout(() => {
                    modal.classList.add('show');
                    modal.style.display = 'flex';
                    log('‚úÖ Modal ouvert avec d√©lai de 50ms');
                }, 50);
            }
        }
        
        function closeTestModal() {
            log('‚ùå Fermeture du modal...');
            const modal = document.getElementById('testModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        }
        
        // Event listeners avec protection
        document.addEventListener('DOMContentLoaded', function() {
            log('üìÑ Page charg√©e');
            
            const openBtn = document.getElementById('test-modal-btn');
            if (openBtn) {
                openBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    log('üîò Clic sur bouton ouvrir (propagation arr√™t√©e)');
                    openTestModal();
                });
            }
            
            const modal = document.getElementById('testModal');
            if (modal) {
                // Fermer sur overlay (mais pas sur contenu)
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        log('üîò Clic sur overlay - fermeture');
                        closeTestModal();
                    }
                });
                
                // Emp√™cher propagation sur le contenu
                const container = modal.querySelector('.modal-container');
                if (container) {
                    container.addEventListener('click', function(e) {
                        e.stopPropagation();
                        log('üîò Clic sur contenu (propagation arr√™t√©e)');
                    });
                }
            }
            
            // Bouton fermer
            const closeBtn = document.getElementById('close-test-modal');
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    log('üîò Clic sur bouton fermer');
                    closeTestModal();
                });
            }
            
            // Bouton annuler
            const cancelBtn = document.getElementById('cancel-test');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    log('üîò Clic sur bouton annuler');
                    closeTestModal();
                });
            }
            
            // Bouton enregistrer (ne ferme pas)
            const saveBtn = document.getElementById('save-test');
            if (saveBtn) {
                saveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    log('üîò Clic sur bouton enregistrer (modal reste ouvert)');
                });
            }
            
            log('‚úÖ Tous les event listeners attach√©s');
        });
        
        // Intercepter tous les clics pour debug
        document.addEventListener('click', function(e) {
            log(`üñ±Ô∏è Clic g√©n√©ral sur: ${e.target.tagName} ${e.target.className || ''}`);
        }, true);
    </script>
</body>
</html>